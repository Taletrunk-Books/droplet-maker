# Setup - Primitive Git Deployment Script

## Overview

This script facilitates the deployment and management of a Git repository on a remote server using SSH and Docker. It provides functionality to set up the repository, deploy specific branches, and clean up Docker resources to manage disk space.

## How to Use

1. **Save the Script:**
   Save the script as `setup.sh` in your repository.

2. **Make the Script Executable:**
   ```bash
   chmod +x setup.sh
   ```

3. **Run the Script:**
   ```bash
   ./setup.sh -b <branch_name>
   ```
   Replace `<branch_name>` with the branch you want to deploy. If no branch is specified, it defaults to `main`.

## Usage Examples

- **Initial Setup with Default Branch (`main`):**
  ```bash
  ./setup.sh
  ```

- **Initial Setup with Specified Branch:**
  ```bash
  ./setup.sh -b dev
  ```

- **Reconnect and Refresh Docker Setup:**
  ```bash
  ./setup.sh -b feature-x
  ```

- **Clean Configuration:**
  ```bash
  ./setup.sh --clean
  ```

- **Clean Docker Space:**
  ```bash
  ./setup.sh --cleanup
  ```

## Script Functions

### 1. Initial Setup (`setup_config`)

- **Prompts for User Input:** Asks for the repository link, SSH key location, SSH username, SSH IP, and the repository folder name.
- **Stores Configuration:** Saves these inputs in `setup.cfg`.
- **Adds to .gitignore:** Ensures `setup.cfg` is added to `.gitignore`.

### 2. SSH Setup and Repository Cloning (`setup_ssh_and_clone`)

- **Reads Configuration:** Loads data from `setup.cfg`.
- **SSH Connection:** Establishes an SSH connection using the provided details.
- **Clones Repository:** Clones the specified branch of the repository if it doesn't already exist.
- **Docker Setup:** Navigates to the repository folder, builds, and starts the Docker containers using `docker compose`.

### 3. Reconnect and Refresh (`reconnect_and_refresh`)

- **Reads Configuration:** Loads data from `setup.cfg`.
- **SSH Connection:** Establishes an SSH connection, navigates to the repository folder.
- **Branch Management:** Checks out and pulls the latest changes from the specified branch.
- **Docker Refresh:** Stops running Docker containers, cleans up unused Docker resources, rebuilds, and starts the Docker setup.

### 4. Clean Docker Space (`clean_docker_space`)

- **Reads Configuration:** Loads data from `setup.cfg`.
- **SSH Connection:** Establishes an SSH connection.
- **Docker Cleanup:** Runs `docker system prune -f` to clean up unused Docker resources.

### 5. Main Script Logic

- **Clean Configuration (`--clean`):** Deletes `setup.cfg` to force a fresh setup.
- **Docker Cleanup (`--cleanup`):** Cleans up Docker resources based on the current configuration.
- **Setup or Refresh:** Determines whether to run the initial setup or reconnect and refresh based on the presence of `setup.cfg`.

## Configuration File (`setup.cfg`)

The `setup.cfg` file is generated by the script during the initial setup and contains the following entries:

- `REPO_LINK`: The Git repository link.
- `RSA_FILE`: The file path to the SSH private key.
- `SSH_USER`: The SSH username.
- `SSH_IP`: The IP address of the remote server.
- `REPO_FOLDER`: The name of the folder where the repository is cloned.
  
Example `setup.cfg`:
```ini
REPO_LINK=https://github.com/username/repo.git
RSA_FILE=~/.ssh/id_rsa
SSH_USER=username
SSH_IP=192.168.1.100
REPO_FOLDER=repo
```

## .gitignore Configuration

Ensure `setup.cfg` is ignored by Git by adding it to `.gitignore`:
```bash
echo "setup.cfg" >> .gitignore
```

## Notes

- **SSH Agent:** The script uses `ssh-agent` to manage SSH keys for connections.
- **Docker Compose:** Ensure `docker-compose` is installed and configured on the remote server.
- **GitHub CLI:** Uses GitHub CLI (`gh`) to clone the repository. Make sure `gh` is installed on the remote server.
